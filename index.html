<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Calculator</title>
<meta name="theme-color" content="#000000">

<!-- iOS: полноэкранный запуск без адресной строки -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Calculator">

<style>
  :root{
    --bg:#000;           /* общий фон */
    --fg:#fff;           /* текст на дисплее */
    --btn:#2a2a2a;       /* обычные кнопки */
    --btn2:#5c5c5e;      /* серые спец-кнопки (AC, ±, %) */
    --op:#f69a06;        /* оранжевые операторы */
    --btnText:#fff;
    --muted:#c8c8c8;
    --radius:44px;       /* радиус кружков */
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;background:var(--bg);margin:0;padding:0;overflow:hidden;}
  body{font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
       touch-action: manipulation;}
  .app{
    position:fixed; inset:0;
    padding: calc(env(safe-area-inset-top,0) + 8px) 12px calc(env(safe-area-inset-bottom,0) + 12px);
    display:flex; flex-direction:column; gap:12px;
  }
  /* верхняя строка: меню + индикатор (пустая зона как в iOS) */
  .topbar{
    height:28px; display:flex; align-items:center; justify-content:flex-start;
    color:#f6a31a; font-size:22px; padding-left:2px; user-select:none;
  }
  .hamburger{
    width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .hamburger::before{
    content:"\2630"; /* ☰ */
    line-height:1; transform: translateY(-1px);
  }

  /* дисплей */
  .display{
    flex:1;
    display:flex; align-items:flex-end; justify-content:flex-end;
    color:var(--fg); font-weight:600; font-variant-numeric: tabular-nums lining-nums;
    letter-spacing:1px;
    padding:0 12px;
  }
  .value{
    font-size:min(20vw, 112px);
    line-height:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* сетка кнопок */
  .grid{
    display:grid; gap:12px;
    grid-template-columns: repeat(4, 1fr);
  }
  button{
    outline:none; border:none; border-radius:var(--radius);
    height:72px; font-size:32px; color:var(--btnText);
    background:var(--btn); cursor:pointer; font-weight:500;
  }
  button:active{filter:brightness(1.15)}
  .sm{ font-size:26px }
  .light{ background:var(--btn2); color:#fff }
  .op{ background:var(--op); color:#fff }
  .zero{ grid-column: span 2; text-align:left; padding-left:30px }

  /* иконка backspace на кнопке слева вместо AC */
  .icon-back::before{
    content:"⌫";
    font-size:28px;
  }

  /* скрытое модальное окно для Full Reset */
  .sheet{
    position:fixed; inset:0; background:rgba(0,0,0,.35);
    display:none; align-items:flex-end; justify-content:center; z-index:50;
  }
  .sheet.open{ display:flex }
  .sheet .panel{
    width:100%; background:#1b1b1d; border-top-left-radius:18px; border-top-right-radius:18px;
    padding:14px 16px 20px; color:#fff;
  }
  .sheet .grab{ width:48px; height:4px; background:#3a3a3c; border-radius:2px; margin:6px auto 14px; }
  .sheet h3{margin:0 0 10px 0; font-size:16px; color:#bbb; text-align:center}
  .danger{
    width:100%; height:54px; border-radius:14px; background:#ff453a; color:#fff;
    font-size:18px; border:none;
  }
  .ghost{
    margin-top:10px; width:100%; height:50px; border-radius:14px; background:#2c2c2e; color:#fff;
    font-size:16px; border:none;
  }

  /* предотвращаем внезапные переносы на очень узких экранах */
  @media (max-width:360px){
    .value{ font-size:min(22vw, 96px); }
  }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="topbar">
    <div class="hamburger" id="btnMenu" aria-label="menu"></div>
  </div>

  <div class="display">
    <div class="value" id="display">0</div>
  </div>

  <div class="grid" id="keys">
    <button class="light" data-key="AC" id="keyAC">AC</button>
    <button class="light sm" data-key="+/-">+/−</button>
    <button class="light sm" data-key="%">%</button>
    <button class="op sm" data-key="÷">÷</button>

    <button data-key="7">7</button>
    <button data-key="8">8</button>
    <button data-key="9">9</button>
    <button class="op sm" data-key="×">×</button>

    <button data-key="4">4</button>
    <button data-key="5">5</button>
    <button data-key="6">6</button>
    <button class="op sm" data-key="−">−</button>

    <button data-key="1">1</button>
    <button data-key="2">2</button>
    <button data-key="3">3</button>
    <button class="op sm" data-key="+">+</button>

    <button class="zero" data-key="0">0</button>
    <button data-key=".">.</button>
    <button class="op" data-key="=" id="keyEq">=</button>
  </div>
</div>

<!-- Секретный Full Reset (открывается долгим тапом по ☰) -->
<div class="sheet" id="sheet">
  <div class="panel">
    <div class="grab"></div>
    <h3>Hidden Actions</h3>
    <button class="danger" id="btnFullReset">Full Reset</button>
    <button class="ghost" id="btnCloseSheet">Close</button>
  </div>
</div>

<script>
/* ---------- утилиты жестов ---------- */
function onLongPress(el, ms, handler){
  let t=null;
  el.addEventListener('touchstart', e=>{ t=setTimeout(()=>handler(e), ms) }, {passive:true});
  el.addEventListener('touchend',   ()=>{ clearTimeout(t) });
  el.addEventListener('touchmove',  ()=>{ clearTimeout(t) });
  el.addEventListener('mousedown',  ()=>{ t=setTimeout(handler, ms) });
  el.addEventListener('mouseup',    ()=>{ clearTimeout(t) });
  el.addEventListener('mouseleave', ()=>{ clearTimeout(t) });
}
function now(){ return Date.now() }

/* ---------- состояние калькулятора ---------- */
const display   = document.getElementById('display');
const keys      = document.getElementById('keys');
const keyAC     = document.getElementById('keyAC');
const keyEq     = document.getElementById('keyEq');
const sheet     = document.getElementById('sheet');
const btnMenu   = document.getElementById('btnMenu');

let state = {
  cur: '0',          // текущее число (строка)
  prev: null,        // предыдущее число (string)
  op: null,          // текущий оператор '+', '−', '×', '÷'
  justEvaluated:false,
  // секретный режим
  secret:false,           // включён ли «магический» режим
  secretChosen:null,      // выбранная «угадываемая» цифра
  secretArmed:false,      // после выбора цифры ожидаем нажатие зрителя
};

function setDisplay(val){
  // форматируем как iOS (без лишних нулей)
  if (typeof val === 'number') val = String(val);
  if (val.indexOf('.')>=0){
    val = val.replace(/\.0+$/,'').replace(/(\.\d*?[1-9])0+$/,'$1');
  }
  if (val === '' || val === '-') val = '0';
  display.textContent = val;
}

function updateACVisual(){
  // если есть ввод — показываем backspace
  const showBack = state.cur !== '0' || state.justEvaluated;
  keyAC.textContent = showBack ? '' : 'AC';
  keyAC.classList.toggle('icon-back', showBack);
}

/* ---------- обычная логика калькулятора ---------- */
function inputDigit(d){
  if (state.justEvaluated){
    state.cur = d; state.justEvaluated=false;
  } else {
    state.cur = (state.cur==='0') ? d : state.cur + d;
  }
}
function inputDot(){
  if (state.justEvaluated){ state.cur='0.'; state.justEvaluated=false; return; }
  if (!state.cur.includes('.')) state.cur += '.';
}
function toggleSign(){
  if (state.cur==='0') return;
  state.cur = state.cur.startsWith('-') ? state.cur.slice(1) : '-' + state.cur;
}
function percent(){
  let n = parseFloat(state.cur||'0');
  n = n/100;
  state.cur = String(n);
}
function setOperator(op){
  if (state.op && !state.justEvaluated){
    // вычисляем по цепочке как в iOS
    evaluate();
  }
  state.prev = state.cur;
  state.op = op;
  state.justEvaluated=false;
  state.cur='0';
}
function evaluate(){
  if (!state.op || state.prev===null) return;
  const a = parseFloat(state.prev), b = parseFloat(state.cur);
  let r = 0;
  switch(state.op){
    case '+': r = a + b; break;
    case '−': r = a - b; break;
    case '×': r = a * b; break;
    case '÷': r = b===0 ? NaN : a / b; break;
  }
  state.cur = String(r);
  state.prev=null; state.op=null; state.justEvaluated=true;
}
function backspace(){
  if (state.justEvaluated){ state.cur='0'; state.justEvaluated=false; return; }
  if (state.cur.length <= 1 || (state.cur.length===2 && state.cur.startsWith('-'))){
    state.cur = '0';
  } else {
    state.cur = state.cur.slice(0,-1);
  }
}

/* ---------- секретный режим ---------- */
// двойное нажатие по AC включает secret
let lastACTap = 0;
function handleAC(){
  const t = now();
  const dbl = (t - lastACTap) < 600;
  lastACTap = t;

  // если есть ввод — работаем как backspace
  if (state.cur!=='0' || state.justEvaluated){
    backspace();
    render();
    if (dbl){ enableSecretMode(); }
    return;
  }
  // пусто: полный сброс обычный
  hardReset();
  if (dbl){ enableSecretMode(); }
}
function enableSecretMode(){
  state.secret = true;
  state.secretChosen = null;
  state.secretArmed = false;
  // ничего визуально не меняем
}

function secretDigitSelect(d){
  if (!state.secret) return false;
  if (state.secretChosen === null){
    state.secretChosen = d;     // тихо выбранная цифра
    state.secretArmed   = true; // ждём зрителя
    return true;                // поглотили событие
  }
  return false;
}

function secretMaybeShowForced(){
  if (!state.secret) return false;
  if (state.secretArmed && state.secretChosen !== null){
    state.cur = state.secretChosen;
    state.justEvaluated=false;
    // остаёмся в режиме и дальше «липнем» к выбранной цифре
    return true;
  }
  return false;
}
function exitSecretMode(){
  state.secret=false;
  state.secretChosen=null;
  state.secretArmed=false;
}

/* ---------- сбросы ---------- */
function hardReset(){
  state.cur='0'; state.prev=null; state.op=null; state.justEvaluated=false;
}
function fullResetAll(){
  hardReset(); exitSecretMode(); render();
}

/* ---------- обработка нажатий ---------- */
keys.addEventListener('click', (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const key = btn.dataset.key;

  // секрет: первая цифра после активации выбирает принудительную
  if (/^\d$/.test(key) && secretDigitSelect(key)){ /* селектнули — выходим */
    return;
  }

  // если секрет активен и «заряжен» — любое нажатие показывает выбранную цифру
  if (secretMaybeShowForced()){ render(); return; }

  switch(key){
    case 'AC': handleAC(); break;
    case '+/-': toggleSign(); break;
    case '%': percent(); break;
    case '.': inputDot(); break;
    case '+': case '−': case '×': case '÷': setOperator(key); break;
    case '=': evaluate(); exitSecretMode(); break;
    default:  // цифры
      if(/^\d$/.test(key)){ inputDigit(key); }
  }
  render();
});

/* длинное нажатие на "=" — аварийный выход из секрета */
onLongPress(keyEq, 1500, ()=>{ exitSecretMode(); render(); });

/* AC ведёт себя как backspace/AC + двойной тап — секрет; длинный тап — жёсткий сброс */
onLongPress(keyAC, 1000, ()=>{ fullResetAll(); });

/* скрытый Full Reset через долгий тап по ☰ */
onLongPress(btnMenu, 1200, ()=>{ sheet.classList.add('open'); });
document.getElementById('btnCloseSheet').onclick = ()=> sheet.classList.remove('open');
document.getElementById('btnFullReset').onclick  = ()=>{ sheet.classList.remove('open'); fullResetAll(); };

/* ---------- рендер ---------- */
function render(){
  setDisplay(state.cur);
  updateACVisual();
}
render();

/* ---------- запрет жестов зума на iOS Safari ---------- */
document.addEventListener('gesturestart', e=> e.preventDefault());
let lastTouchEnd=0;
document.addEventListener('touchend', e=>{
  const nowTs=Date.now();
  if (nowTs-lastTouchEnd<=300) e.preventDefault();
  lastTouchEnd=nowTs;
}, {passive:false});
</script>
</body>
</html>
