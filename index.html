<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Flashcards EN‚ÜîES ‚Äî One File</title>
<link rel="icon" href="favicon.png" type="image/png" sizes="32x32">
<link rel="apple-touch-icon" href="favicon.png">
<style>
  :root{
    --bg0:#0b0a12; --bg1:#141126; --grad1:#5b3ee4; --grad2:#a25bff;
    --text:#f6f5ff; --muted:#c6c2df; --green:#25a46a; --blue:#2b74ff; --red:#ff4d6d;
    --card:#1b1733; --shadow: 0 10px 30px rgba(0,0,0,.35), 0 6px 18px rgba(42,22,87,.25);
    --radius:18px; --ease:cubic-bezier(.22,.61,.36,1); --shadow-soft: 0 8px 20px rgba(90,64,200,.25);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;color:var(--text);
    background: radial-gradient(1200px 600px at 20% -10%, rgba(162,91,255,.25), transparent 60%),
               radial-gradient(1000px 700px at 120% 10%, rgba(91,62,228,.25), transparent 60%),
               linear-gradient(180deg, var(--bg1), var(--bg0));
    font:16px/1.45 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
  }
  .wrap{max-width:460px;margin:0 auto;padding:16px 16px calc(env(safe-area-inset-bottom) + 20px)}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(20,17,38,.9), rgba(20,17,38,.6), transparent);backdrop-filter:saturate(1.1) blur(6px);margin:0 -16px 10px;padding:10px 16px 6px}
  .bar{height:8px;background:#2a2446;border-radius:999px;overflow:hidden;box-shadow:var(--shadow-soft);margin-bottom:10px}
  .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--grad1),var(--grad2));transition:width .3s var(--ease)}
  .meta{font-size:13px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
  .tabs{display:grid;grid-template-columns:auto 1fr auto;align-items:center;margin-top:10px;gap:8px}
  .iconbtn{appearance:none;border:none;background:#251f44;color:var(--text);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow-soft);cursor:pointer;transition:transform .15s var(--ease), opacity .15s var(--ease)}
  .iconbtn:active{transform:scale(.95)}
  .tabbar{display:flex;background:#1f1a3a;border-radius:12px;padding:4px;gap:4px;box-shadow:var(--shadow-soft)}
  .tabbar button{flex:1;appearance:none;border:none;background:transparent;color:var(--muted);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;transition:background .2s var(--ease), color .2s var(--ease)}
  .tabbar button.active{background:linear-gradient(180deg,#2a2452,#221d44);color:var(--text);box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
  /* –¢–∞–±—ã ‚Äî —á—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –ø–æ –ø–∞–¥–¥–∏–Ω–≥–∞–º */
.tabbar .tab{ padding:8px 12px; }
.tabbar .dirbtn{
  flex:0 0 auto;
  padding:6px 10px;
  margin:0 4px;
  font-size:13px;       
}

/* –ö–Ω–æ–ø–∫–∞ EN‚ÜíES –ø–æ —Ü–µ–Ω—Ç—Ä—É ‚Äî —É–∑–∫–∞—è, –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
.tabbar .dirbtn{
  flex:0 0 auto;           /* –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å –∫–∞–∫ —Ç–∞–±—ã */
  padding:6px 10px;        /* —É–∂–µ –∏ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
  margin:0 4px;
  background:#251f44;
  color:var(--text);
  border-radius:10px;
  font-weight:700;
  box-shadow:var(--shadow-soft);
  border:none;
  cursor:pointer;
  transition:transform .12s var(--ease), opacity .2s var(--ease);
}
.tabbar .dirbtn:active{ transform:scale(.95) }

  .cardwrap{margin-top:14px}
  .card3d{position:relative;height:min(64vh,360px);aspect-ratio:3/4;margin:0 auto;border-radius:var(--radius);perspective:1200px;overflow:visible}
  .card{position:absolute;inset:0;border-radius:var(--radius);transform-style:preserve-3d;transition:transform .6s var(--ease)}
  .face{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:clamp(20px,4.8vw,26px);padding:18px;text-align:center;border-radius:var(--radius);background:linear-gradient(180deg,var(--cardGrad1,#2a2452),var(--cardGrad2,#211c40));box-shadow:var(--shadow);backface-visibility:hidden}
  .back{transform:rotateY(180deg)}
  .zones{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr 1fr;border-radius:var(--radius);overflow:hidden}
  .zones button{appearance:none;background:transparent;border:none}
  .zones button:active{background:rgba(255,255,255,.06)}
  .controls{display:flex;gap:10px;margin-top:14px}
  .btn{flex:1;appearance:none;border:none;border-radius:14px;padding:14px 16px;font-size:16px;font-weight:700;cursor:pointer;transition:transform .12s var(--ease), filter .2s var(--ease), opacity .2s var(--ease);box-shadow:var(--shadow-soft)}
  .btn:active{transform:scale(.95)}
  .btn.green{background:linear-gradient(180deg,#1e9a66,#148c5c)}
  .btn.blue{background:linear-gradient(180deg,#3b7bff,#2d68e8)}
  .row{display:flex;gap:8px;align-items:center;margin-top:14px;flex-wrap:wrap}
  .chip{appearance:none;border:none;background:#251f44;color:var(--text);padding:10px 12px;border-radius:999px;cursor:pointer;box-shadow:var(--shadow-soft);font-size:14px}
  .chip:active{transform:scale(.95)}
  
  .listwrap{margin-top:8px}
  .list{background:#1a1534;border-radius:12px;overflow:hidden;box-shadow:var(--shadow-soft)}
  details{border-top:1px solid rgba(255,255,255,.06)} details:first-child{border-top:none}
  summary{list-style:none;padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  summary::-webkit-details-marker{display:none}
  .status{font-size:12px;color:var(--muted)} .pill{padding:4px 8px;border-radius:999px;background:#2a2446;margin-left:8px;font-size:12px}
  .quiz{margin-top:12px;background:#1a1534;border-radius:14px;padding:16px;box-shadow:var(--shadow-soft)}
  .quiz h3{margin:0 0 8px}
  .opts{display:grid;gap:10px;margin-top:10px}
  .opts button{
  text-align:left;appearance:none;border:none;border-radius:12px;
  padding:14px 16px;               /* –±—ã–ª–æ 12px 14px */
  font-size:18px;                  /* –¥–æ–±–∞–≤–∏–ª–∏ —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
  line-height:1.3;                 /* —á–∏—Ç–∞–±–µ–ª—å–Ω–µ–µ */
  min-height:48px;                 /* —É–¥–æ–±–Ω–∞—è ¬´—Ç–∞–ø-—Ü–µ–ª—å¬ª */
  background:#231d43;color:var(--text);
  cursor:pointer;
  transition:transform .12s var(--ease), background .15s var(--ease)
}
  .opts button:active{transform:scale(.97)}
  .opts button.correct{background:rgba(37,164,106,.25);outline:1px solid rgba(37,164,106,.7)}
  .opts button.wrong{background:rgba(255,77,109,.18);outline:1px solid rgba(255,77,109,.7)}
  dialog{border:none;border-radius:16px;background:#191532;color:var(--text);padding:0;box-shadow:0 20px 80px rgba(0,0,0,.6)}
  dialog::backdrop{background:rgba(0,0,0,.45);backdrop-filter:blur(3px)}
  .modal{padding:16px;min-width:min(92vw,420px)}
  .modal h3{margin:0 0 10px}
  .modal .row{margin-top:10px}
  .modal input{width:100%;appearance:none;border:none;border-radius:12px;padding:10px 12px;background:#231e46;color:var(--text);outline:none}
  /* –Ω–µ —Ç—Ä–æ–≥–∞–µ–º actions –≤–Ω—É—Ç—Ä–∏ #dlgAdd */
.modal .actions:not(.actions-add){
  display:flex;
  gap:10px;
  justify-content:flex-end;
  margin-top:12px;
}

  /* –ö–Ω–æ–ø–∫–∏ –≤ –¥–∏–∞–ª–æ–≥–µ "–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞" ‚Äî –º–æ–±–∏–ª—å–Ω—ã–π –≤–∏–¥ (2 –∫–æ–ª–æ–Ω–∫–∏) */
.actions-add{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  /* –≤–∞–∂–Ω–æ: –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–æ, —á—Ç–æ –∑–∞–¥–∞—ë—Ç .modal .actions */
  justify-content: unset;
  align-content: start;
}
.actions-add .chip{
  width:100%;
  min-width:0;          /* Safari iOS: –ø–æ–∑–≤–æ–ª—è–µ–º –∫–Ω–æ–ø–∫–µ —Å–∂–∏–º–∞—Ç—å—Å—è –≤–Ω—É—Ç—Ä–∏ –≥—Ä–∏–¥–∞ */
}

/* –î–µ—Å–∫—Ç–æ–ø: –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
@media (min-width:680px){
  #dlgAdd .modal{ min-width:560px; }
  .actions-add{
    display:flex;
    flex-wrap:nowrap;
    gap:10px;
    justify-content:space-between;
  }
  .actions-add .chip{ width:auto; }
}

  .footnote{margin-top:10px;color:var(--muted);font-size:12px}
  .linklike{color:#9ea0ff;text-decoration:underline;cursor:pointer}
  :focus-visible{outline:2px solid #8c7aff;outline-offset:2px;border-radius:10px}
  .spinner{display:inline-block;min-width:1.2em}
 
 /* ---- Color palettes in Settings ---- */
.palette{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.swatch{width:28px;height:28px;border-radius:8px;border:none;cursor:pointer;box-shadow:var(--shadow-soft);
        outline:1px solid rgba(255,255,255,.08)}
.swatch[aria-pressed="true"]{outline:2px solid #8c7aff}
</style>
</head>
<body>
<div class="wrap" id="app" aria-live="polite">
  <header>
  <div class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—É—á–µ–Ω–∏—è"><span id="progressFill"></span></div>
  <div class="meta" id="progressText">–ü—Ä–æ–≥—Ä–µ—Å—Å: 0% (0/0) | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å: 0</div>

  <div class="tabs" role="tablist" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫">
    <button class="iconbtn" id="btnSettings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>

    <div class="tabbar">
      <button role="tab" aria-selected="true" id="tabFlash" class="tab active">Flashcards</button>
      <button class="dirbtn" id="btnDirection" type="button" title="–°–º–µ–Ω–∏—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">EN‚ÜíES</button>
      <button role="tab" aria-selected="false" id="tabQuiz" class="tab">–ö–≤–∏–∑</button>
    </div>

    <button class="iconbtn" id="btnAdd" title="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É" aria-label="–î–æ–±–∞–≤–∏—Ç—å">Ôºã</button>
  </div>
</header>

  <!-- FLASHCARDS -->
  <section id="viewFlash">
    <div class="cardwrap">
      <div class="card3d" aria-label="–ö–∞—Ä—Ç–æ—á–∫–∞">
        <div class="card" id="card">
          <div class="face front" id="frontText">Front</div>
          <div class="face back" id="backText">Back</div>
        </div>
        <div class="zones" aria-hidden="true">
          <button id="zoneBack" title="–ù–∞–∑–∞–¥" aria-label="–ù–∞–∑–∞–¥"></button>
          <button id="zoneFlip" title="–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å" aria-label="–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç—å"></button>
          <button id="zoneNext" title="–î–∞–ª–µ–µ" aria-label="–î–∞–ª–µ–µ"></button>
        </div>
      </div>
      <div class="controls">
        <button class="btn blue"  id="btnRepeat"  style="color:#fff !important; -webkit-text-fill-color:#fff">‚Ü∫ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
<button class="btn green" id="btnLearned" style="color:#fff !important; -webkit-text-fill-color:#fff">‚úî –ó–∞–ø–æ–º–Ω–∏–ª</button>
      </div>
    </div>

    <div class="row"><div id="counters" class="meta">–í—Å–µ–≥–æ: 0 ‚Ä¢ –í—ã—É—á–µ–Ω–æ: 0 ‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å: 0</div></div>

        <div class="listwrap" id="mainListWrap" hidden>
  <div class="list" id="list"></div>
</div>
  </section>

  <!-- QUIZ -->
  <section id="viewQuiz" hidden>
    <div class="quiz" role="group" aria-label="–ö–≤–∏–∑">
      <div class="meta" id="quizMeta">–≤–æ–ø—Ä–æ—Å 0 –∏–∑ 0, –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö 0</div>
      <h3 id="quizPrompt">‚Ä¶</h3>
      <div class="opts" id="quizOpts"></div>
      <div class="row"><button class="chip" id="quizRestart" hidden>–°–Ω–æ–≤–∞</button></div>
    </div>
  </section>
</div>

<!-- SETTINGS MODAL -->
<dialog id="dlgSettings" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
  <form method="dialog" class="modal">
  <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>

  <div class="row" style="flex-direction:column;align-items:flex-start;width:100%">
    <div>–§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
    <div id="bgPalette" class="palette" aria-label="–í—ã–±–æ—Ä —Ñ–æ–Ω–∞"></div>
  </div>

  <div class="row" style="flex-direction:column;align-items:flex-start;width:100%">
    <div>–¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>
    <div id="cardPalette" class="palette" aria-label="–í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞ –∫–∞—Ä—Ç–æ—á–µ–∫"></div>
  </div>

  <div class="row">
  <button type="button" class="chip" id="btnToggleList" aria-expanded="true">–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫</button>
  <button type="button" class="chip" id="btnReset"
    onclick="localStorage.removeItem('minimal-flashcards-html-v1'); location.reload();">
    –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö
  </button>
</div>
<div id="settingsListWrap" class="listwrap" hidden></div>
  <div class="actions"><button class="chip" value="cancel">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</form>
</dialog>

<!-- ADD MODAL -->
<dialog id="dlgAdd" aria-label="–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É" tabindex="-1">
  <form method="dialog" class="modal" id="addForm">
    <h3>–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞</h3>

    <div class="row"><input id="addFront" placeholder="Front (EN)" autocomplete="off" /></div>
    <div class="row"><input id="addBack"  placeholder="Back (ES)"  autocomplete="off" /></div>

    <div class="row" style="justify-content:space-between;width:100%">
      <label style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" id="autoTranslate" checked />
        <span>–ê–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥</span>
      </label>
      <div class="meta" id="trStatus"><span class="spinner" aria-live="polite"></span></div>
    </div>

    <!-- –ï–î–ò–ù–´–ô –±–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ -->
    <div class="actions actions-add">
      <button class="chip" type="button" id="btnTranslate">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      <button class="chip" type="button" id="btnClearAdd">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button class="chip" type="submit" id="btnAddConfirm">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button class="chip" type="button" id="btnAddClose" autofocus>–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div class="footnote">–û–Ω–ª–∞–π–Ω-–ø–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ LibreTranslate. –ï—Å–ª–∏ —Å–µ—Ç–∏ –Ω–µ—Ç ‚Äî –æ—Ñ–ª–∞–π–Ω —à–∞–±–ª–æ–Ω—ã (&gt;1000 —Ç–∏–ø–æ–≤—ã—Ö —Ñ—Ä–∞–∑) –∏ –º–∏–Ω–∏-—Å–ª–æ–≤–∞—Ä—å.</div>
  </form>
</dialog>

<script>
(() => {
  const STORAGE_KEY = 'minimal-flashcards-html-v1';

  /** ---------- Helpers ---------- */
  const $ = sel => document.querySelector(sel);
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const now = ()=>Date.now();
  function prng(seed){ const x = Math.sin(seed)*10000; return x - Math.floor(x); }
  function weightedPick(weights, excludeIndex=null, seed=1){
    const n=weights.length, total=weights.reduce((a,b)=>a+b,0); if(total<=0)return -1;
    let r=prng(seed)*total, acc=0, pick=0; for(let i=0;i<n;i++){ acc+=weights[i]; if(r<=acc){ pick=i; break; } }
    if(excludeIndex!=null && n>1 && pick===excludeIndex){ r=prng(seed+0.1234)*total; acc=0; for(let i=0;i<n;i++){ acc+=weights[i]; if(r<=acc){ pick=i; break; } } }
    return pick;
  }
  function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
  function loadState(){ try{const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return null; return JSON.parse(raw);}catch(e){console.warn('loadState fail',e); return null;} }
  function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  /** ---------- State ---------- */
const state = {
  cards: [],
  currentId: null,
  direction: 'EN2ES',
  tab: 'flash',
  shuffleSeed: 1.2345,
  showList: false,

  // —Å—Ç–µ–∫ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ (–¥–ª—è ¬´–Ω–∞–∑–∞–¥¬ª)
  history: [],

  theme: { bg0:'', bg1:'', card1:'', card2:'' },

  quiz: { pool:[], index:0, right:0, finished:false, lastAnswer:null }
};

  /** ---------- DOM ---------- */
  const elProgressFill = $('#progressFill'), elProgressText=$('#progressText'), elCounters=$('#counters');
  const elFront=$('#frontText'), elBack=$('#backText'), elCard=$('#card'), elList=$('#list');
const mainListWrap = $('#mainListWrap');
const settingsListWrap = $('#settingsListWrap');
const elBtnDir=$('#btnDirection'), btnToggleList=$('#btnToggleList');
  const elZoneBack=$('#zoneBack'), elZoneFlip=$('#zoneFlip'), elZoneNext=$('#zoneNext');
  const btnLearned=$('#btnLearned'), btnRepeat=$('#btnRepeat');
  const tabFlash=$('#tabFlash'), tabQuiz=$('#tabQuiz'), viewFlash=$('#viewFlash'), viewQuiz=$('#viewQuiz');
  const btnSettings=$('#btnSettings'), btnAdd=$('#btnAdd'), dlgSettings=$('#dlgSettings');
  const dlgAdd=$('#dlgAdd'), addForm=$('#addForm'), addFront=$('#addFront'), addBack=$('#addBack');
  const btnClearAdd=$('#btnClearAdd');
  const btnAddClose = $('#btnAddClose');
  const quizMeta=$('#quizMeta'), quizPrompt=$('#quizPrompt'), quizOpts=$('#quizOpts'), quizRestart=$('#quizRestart');
  const autoTranslate=$('#autoTranslate'), btnTranslate=$('#btnTranslate'), trStatus=$('#trStatus');
  const bgPalette=$('#bgPalette'), cardPalette=$('#cardPalette');
 
  /** ---------- App ---------- */
  function uid(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }
  function addCard(front, back, demo=false){
    const c={id:uid(), front:String(front).trim(), back:String(back).trim(), box:1, hard:false, repeat:false, learned:false, last:Date.now()};
    if(demo){ state.cards.push(c); } else { state.cards.unshift(c); }
    if(!state.currentId) state.currentId=c.id; saveState();
  }
  function ensureDemo(){ if(state.cards.length) return;
addCard('Hello! Good morning','¬°Hola! Buenos d√≠as',true);
addCard('Thank you','¬°Gracias!',true);
addCard('How much is this?','¬øCu√°nto cuesta esto?',true)
addCard('The salad','La ensalada',true);
addCard('The soup','La sopa',true);
addCard('a menu','un men√∫',true);
addCard('a napkin','una servilleta',true);
addCard('Thank you very much','¬°Muchas gracias!',true);
addCard('Goodbye!','¬°Adi√≥s!',true);
addCard('Very well, and you?','Muy bien, ¬øy t√∫?',true);
addCard('a fork','un tenedor',true);
addCard('a spoon','una cuchara',true);
addCard('The United States','los Estados Unidos',true);
addCard('Wow excellent!','¬°Wow! ¬°Qu√© bueno!',true);
addCard('Hello, How are you?','Hola, ¬øc√≥mo est√°s?',true);
addCard('Yes, of course','S√≠, claro',true);
addCard('Where are you from?','¬øDe d√≥nde eres?',true);
addCard('A table for two, please','Una mesa para dos, por favor',true);
addCard('do sports','hacer deportes',true);
addCard('the fish','el pescado',true);
addCard('read','leer',true);
addCard('write','escribir',true);
addCard('I am Max','Yo soy Max',true);
addCard('Hello, nice to meet you','Hola, mucho gusto',true);
addCard('Welcome!','¬°Bienvenidos!',true);
addCard('cook','cocinar',true);
addCard('I am from Armenia','Yo soy de Armenia',true);
addCard('Delicious food','Comida rica',true);
addCard('What do you like to do?','¬øQu√© te gusta hacer?',true);
addCard('Welcome to the restaurant!','¬°Bienvenido(a) al restaurante!',true);
addCard('What is your name?','¬øC√≥mo te llamas?',true);
addCard('Could you bring a menu please?','¬øPodr√≠a traer un men√∫, por favor?',true);
addCard('What do you like to cook?','¬øQu√© te gusta cocinar?',true);
addCard('My name is Victor (I am called)','Me llamo Victor',true);
addCard('See you later','Hasta luego',true);
addCard('You are welcome (It is nothing)','De nada',true);
addCard('I like your Spanish','¬°Me gusta tu espa√±ol!',true);
addCard('I am from the United States','Yo soy de los Estados Unidos',true);
addCard('Mexico','M√©xico',true);
addCard('Canada','Canad√°',true);
addCard('France','Francia',true);
addCard('How many people are in your party? (How many are you?)','¬øCu√°ntos son?',true);
addCard('Do you want anything else?','¬øDesea algo m√°s?',true);
addCard('I would recommend the pasta','Le recomendar√≠a la pasta',true);
addCard('What would you like? (What (do you) desire?)','¬øQu√© desea?',true);
addCard('I like to read (write)','Me gusta leer (escribir)',true);
addCard('What do you recommend? (me)','¬øQu√© me recomienda?',true);
addCard('I like to do yoga (sports)','Me gusta hacer yoga (deportes)',true);
addCard('Can you say that again, please?','¬øPuedes decirlo de nuevo, por favor?',true);
addCard('What don‚Äôt you like to do?','¬øQu√© no te gusta hacer?',true);
addCard('I don‚Äôt like to do yoga','No me gusta hacer yoga',true);
addCard('I don‚Äôt like to read (write)','No me gusta leer (escribir)',true);
addCard('Oh, I see','Ah, ya veo',true);
addCard('I‚Äôm sorry, what did you say?','Disculpa, ¬øqu√© dijiste?',true);
addCard('draw','dibujar',true);
addCard('paint','pintar',true);
addCard('study Spanish','estudiar espa√±ol',true);
addCard('sing','cantar',true);
addCard('I like to study Spanish','Me gusta estudiar espa√±ol',true);
addCard('I like to draw and paint','Me gusta dibujar y pintar',true);
addCard('I like to cook and do sports','Me gusta cocinar y hacer deportes',true);
addCard('Can you repeat that again, please?','¬øPuedes repetir eso de nuevo, por favor?',true);
addCard('That‚Äôs wonderful!','¬°Maravilloso!',true);
addCard('–Ø –≤–æ—Å—Ö–∏—â–µ–Ω','Encantado',true); // –ø–æ —Å–º—ã—Å–ª—É –µ—â—ë –≤–∞—Ä–∏–∞–Ω—Ç: "Estoy impresionado" (–¥–ª—è –º—É–∂. —Ä–æ–¥–∞)
addCard('What do you like to do in your free time?','¬øQu√© te gusta hacer en tu tiempo libre?',true);
addCard('I like to sing in my free time','En mi tiempo libre me gusta cantar',true);
addCard('Delicious','¬°Delicioso!',true);
addCard('Brilliant','¬°Brillante!',true);
addCard('fun','divertido',true);
addCard('boring','aburrido',true);
addCard('easy','f√°cil',true);
addCard('difficult','dif√≠cil',true);
addCard('Why do you like to cook?','¬øPor qu√© te gusta cocinar?',true);
addCard('Why don‚Äôt you like to cook?','¬øPor qu√© no te gusta cocinar?',true);
addCard('I like to study Spanish because it‚Äôs easy','Me gusta estudiar espa√±ol porque es f√°cil',true);
addCard('I like to cook because it‚Äôs fun','Me gusta cocinar porque es divertido',true);
addCard('I don‚Äôt like to read because it‚Äôs boring','No me gusta leer porque es aburrido',true);
addCard('I don‚Äôt like to draw because it‚Äôs difficult','No me gusta dibujar porque es dif√≠cil',true);
addCard('I understand','Entiendo',true);
addCard('Let‚Äôs do something fun today','¬°Vamos a hacer algo divertido hoy!',true);
addCard('Monday','lunes',true);
addCard('Tuesday','martes',true);
addCard('Wednesday','mi√©rcoles',true);
addCard('Thursday','jueves',true);
addCard('a plate','un plato',true);
addCard('a cup','una taza',true);
addCard('a wine glass','una copa',true);
addCard('Could you bring a cup, please?','¬øPodr√≠a traer una taza, por favor?',true);                 addCard('six','seis',true);
addCard('seven','siete',true);
addCard('eight','ocho',true);
addCard('nine','nueve',true);
addCard('ten','diez',true);       
                       }

  function computeProgress(){ const total=state.cards.length;
    const learnedCount=state.cards.filter(c=>c.learned===true||c.box>=4).length;
    const toRepeat=state.cards.filter(c=>c.repeat===true||c.hard===true||c.box<=2).length;
    const pct= total? Math.round((learnedCount/total)*100) : 0;
    return {total, learnedCount, toRepeat, pct};
  }
  function refreshProgressUI(){ const {total,learnedCount,toRepeat,pct}=computeProgress();
    elProgressFill.style.width = pct+'%';
    elProgressText.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${pct}% (${learnedCount}/${total}) | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å: ${toRepeat}`;
    elProgressFill.parentElement.setAttribute('aria-valuenow', pct);
    elCounters.textContent = `–í—Å–µ–≥–æ: ${total} ‚Ä¢ –í—ã—É—á–µ–Ω–æ: ${learnedCount} ‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å: ${toRepeat}`;
  }
  function currentCard(){ if(!state.currentId && state.cards.length) state.currentId=state.cards[0].id; return state.cards.find(c=>c.id===state.currentId)||null; }
  function setCardTexts(c){ const dir=state.direction; const front=dir==='EN2ES'? c.front : c.back; const back=dir==='EN2ES'? c.back : c.front; elFront.textContent=front||'‚Äî'; elBack.textContent=back||'‚Äî'; }
  function renderFlash(){ const c=currentCard(); if(!c){ elFront.textContent='–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫'; elBack.textContent='–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ —á–µ—Ä–µ–∑ Ôºã'; return;} setCardTexts(c); }

  function renderList(){
  const items = state.cards;
  if(!items.length){
    elList.innerHTML = `<div style="padding:14px;color:var(--muted)">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</div>`;
    return;
  }

    elList.innerHTML = items.map(c=>{
      const status = c.learned? '‚úî –≤—ã—É—á–µ–Ω–æ' : (c.repeat||c.hard||c.box<=2)? '‚Ü∫ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å' : '–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ';
      return `<details data-id="${c.id}">
        <summary><span>${escapeHtml(c.front)} <span class="status">‚Äî ${escapeHtml(c.back)}</span></span>
          <span class="status">${status}<span class="pill">Box ${c.box}</span></span></summary>
        <div style="padding:0 14px 12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap">
          <button class="chip" data-act="focus">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          <button class="chip" data-act="markLearned">‚úî –ó–∞–ø–æ–º–Ω–∏–ª</button>
          <button class="chip" data-act="markRepeat">‚Ü∫ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
          <button class="chip" data-act="boxUp">‚¨Ü Box</button>
          <button class="chip" data-act="boxDown">‚¨á Box</button>
          <button class="chip" data-act="delete" style="background:#3b1d3b">–£–¥–∞–ª–∏—Ç—å</button>
        </div></details>`;
    }).join('');
  }

  function switchTab(tab){ state.tab=tab;
    tabFlash.classList.toggle('active',tab==='flash'); tabQuiz.classList.toggle('active',tab==='quiz');
    tabFlash.setAttribute('aria-selected',tab==='flash'); tabQuiz.setAttribute('aria-selected',tab==='quiz');
    viewFlash.hidden=tab!=='flash'; viewQuiz.hidden=tab!=='quiz'; saveState(); if(tab==='quiz') startQuiz();
  }

  let flipped=false;
  function flipCard(force){ flipped = typeof force==='boolean'? force : !flipped; elCard.style.transform = flipped? 'rotateY(180deg)':'rotateY(0deg)'; }
  function applyLearned(){ const c=currentCard(); if(!c)return; c.learned=true;c.repeat=false;c.hard=false;c.box=clamp(c.box+1,1,5);c.last=now(); nextCard(true); saveState(); refreshProgressUI(); renderList(); }
  function applyRepeat(){ const c=currentCard(); if(!c)return; c.repeat=true;c.hard=true;c.learned=false;c.box=Math.min(c.box,2);c.last=now(); nextCard(false); saveState(); refreshProgressUI(); renderList(); }
  function directionLabel(){ return state.direction==='EN2ES'?'EN‚ÜíES':'ES‚ÜíEN'; }
  function nextCard(){
  flipCard(false);
  if (state.cards.length <= 1) return;

  const currentIndex = state.cards.findIndex(c => c.id === state.currentId);
  const weights = state.cards.map(c => 1 / Math.max(1, c.box));
  state.shuffleSeed += .517;
  const pick = weightedPick(weights, currentIndex, state.shuffleSeed);

  if (pick >= 0) {
    // –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
    if (state.currentId) {
      state.history.push(state.currentId);
      // —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑—Ä–∞—Å—Ç–∞–ª–∞—Å—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
      if (state.history.length > 200) state.history.shift();
    }
    state.currentId = state.cards[pick].id;
    setCardTexts(state.cards[pick]);
  }
  saveState();
}

function prevCard(){
  // –∏–¥—ë–º –Ω–∞–∑–∞–¥ —Å—Ç—Ä–æ–≥–æ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–∫–∞–∑–æ–≤
  if (!state.history || state.history.length === 0) return;
  const prevId = state.history.pop();
  if (!prevId) return;

  state.currentId = prevId;
  flipCard(false);
  renderFlash();
  saveState();
}

  /** List toggle (single button) */
  function applyListVisibility(){
  if (mainListWrap) mainListWrap.hidden = true;            // –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã—Ç–æ
  if (settingsListWrap) settingsListWrap.hidden = !state.showList; // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –º–æ–¥–∞–ª–∫–µ
  btnToggleList.textContent = state.showList ? '–°–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫' : '–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫';
  btnToggleList.setAttribute('aria-expanded', String(state.showList));
}
  btnToggleList.addEventListener('click', () => { state.showList = !state.showList; applyListVisibility(); saveState(); });

  /** Direction & shuffle */
  elBtnDir.addEventListener('click', ()=>{
  state.direction = (state.direction==='EN2ES' ? 'ES2EN' : 'EN2ES');
  elBtnDir.textContent = directionLabel();

  // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–µ—à–∫–∞—Ä—Ç—É
  const c = currentCard(); 
  if (c) setCardTexts(c);

  // üîÅ –ï—Å–ª–∏ —Å–µ–π—á–∞—Å –æ—Ç–∫—Ä—ã—Ç –∫–≤–∏–∑ ‚Äî –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–¥ –Ω–æ–≤–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  if (state.tab === 'quiz') {
    repaintQuizCurrent();   // <-- –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∏–∂–µ
  }

  saveState();
});

  /** List actions */
  elList.addEventListener('click',(e)=>{
    const btn=e.target.closest('button.chip'); if(!btn) return;
    const details=e.target.closest('details'); if(!details) return;
    const id=details.getAttribute('data-id'); const card=state.cards.find(c=>c.id===id); if(!card) return;
    const act=btn.getAttribute('data-act');
    if (act === 'focus') {
  if (state.currentId) state.history.push(state.currentId);
  state.currentId = id;
  renderFlash();
  details.open = false;
  saveState();
}
    if(act==='markLearned'){ card.learned=true; card.repeat=false; card.hard=false; card.box=clamp(card.box+1,1,5); }
    if(act==='markRepeat'){ card.repeat=true; card.hard=true; card.learned=false; card.box=Math.min(card.box,2); }
    if(act==='boxUp'){ card.box=clamp(card.box+1,1,5); }
    if(act==='boxDown'){ card.box=clamp(card.box-1,1,5); }
    if(act==='delete'){ const i=state.cards.findIndex(c=>c.id===id); if(i>=0) state.cards.splice(i,1); if(state.currentId===id) state.currentId=state.cards[0]?.id??null; }
    saveState(); refreshProgressUI(); renderList(); renderFlash();
  });

/** ---------- Theme presets & palette ---------- */
function setVar(name,val){ document.documentElement.style.setProperty(name, val); }
function applyTheme(t){
  if(!t) return;
  if(t.bg0)   setVar('--bg0', t.bg0);
  if(t.bg1)   setVar('--bg1', t.bg1);
  if(t.card1) setVar('--cardGrad1', t.card1);
  if(t.card2) setVar('--cardGrad2', t.card2);
}

// 10 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ñ–æ–Ω–∞ (bg1 —Å–≤–µ—Ä—Ö—É ‚Üí bg0 —Å–Ω–∏–∑—É)
const BG_PRESETS = [
  {name:'Default',         bg0:'#0b0a12', bg1:'#141126'},
  {name:'Deep Blue',       bg0:'#091735', bg1:'#0a0f2d'},
  {name:'Midnight Purple', bg0:'#100a1a', bg1:'#1a1029'},
  {name:'Emerald',         bg0:'#071512', bg1:'#0b1f1a'},
  {name:'Teal Dark',       bg0:'#0a171a', bg1:'#0d1f24'},
  {name:'Charcoal',        bg0:'#15151b', bg1:'#0e0e12'},
  {name:'Warm Brown',      bg0:'#120b09', bg1:'#1e1310'},
  {name:'Navy',            bg0:'#0f223d', bg1:'#0a1630'},
  {name:'Indigo',          bg0:'#0f0b2c', bg1:'#16123f'},
  {name:'Graphite',        bg0:'#0a0c10', bg1:'#111418'},
];

// 10 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ (card1 —Å–≤–µ—Ä—Ö—É ‚Üí card2 —Å–Ω–∏–∑—É)
const CARD_PRESETS = [
  {name:'Default',     card1:'#2a2452', card2:'#211c40'},
  {name:'Blue Steel',  card1:'#2b3a52', card2:'#1d293d'},
  {name:'Forest',      card1:'#23403a', card2:'#1a2f2a'},
  {name:'Maroon',      card1:'#3f2a2a', card2:'#2d1d1d'},
  {name:'Plum',        card1:'#4a2a3f', card2:'#341d2d'},
  {name:'Dark Gray',   card1:'#404040', card2:'#2a2a2a'},
  {name:'Teal',        card1:'#2a3a46', card2:'#1f2a34'},
  {name:'Brown',       card1:'#453a22', card2:'#352a18'},
  {name:'Indigo',      card1:'#27334f', card2:'#1d2540'},
  {name:'Blue',        card1:'#2a2f52', card2:'#202644'},
];

function buildPalettes(){
  // –§–æ–Ω
  bgPalette.innerHTML='';
  BG_PRESETS.forEach((p)=>{
    const b=document.createElement('button');
    b.className='swatch';
    b.title=p.name;
    b.style.background=`linear-gradient(180deg, ${p.bg1}, ${p.bg0})`;
    const isActive = state.theme.bg0===p.bg0 && state.theme.bg1===p.bg1;
    b.setAttribute('aria-pressed', isActive ? 'true':'false');
    b.addEventListener('click', ()=>{
      state.theme.bg0=p.bg0; state.theme.bg1=p.bg1;
      applyTheme(state.theme); saveState();
      for(const x of bgPalette.querySelectorAll('.swatch')) x.setAttribute('aria-pressed','false');
      b.setAttribute('aria-pressed','true');
    });
    bgPalette.appendChild(b);
  });

  // –ö–∞—Ä—Ç–æ—á–∫–∏
  cardPalette.innerHTML='';
  CARD_PRESETS.forEach((p)=>{
    const b=document.createElement('button');
    b.className='swatch';
    b.title=p.name;
    b.style.background=`linear-gradient(180deg, ${p.card1}, ${p.card2})`;
    const isActive = state.theme.card1===p.card1 && state.theme.card2===p.card2;
    b.setAttribute('aria-pressed', isActive ? 'true':'false');
    b.addEventListener('click', ()=>{
      state.theme.card1=p.card1; state.theme.card2=p.card2;
      applyTheme(state.theme); saveState();
      for(const x of cardPalette.querySelectorAll('.swatch')) x.setAttribute('aria-pressed','false');
      b.setAttribute('aria-pressed','true');
    });
    cardPalette.appendChild(b);
  });
}

  /** Quiz */
  function buildQuizPool(){ return state.cards.filter(c=>c.repeat===true||c.hard===true||c.box<=2); }
  function startQuiz(){
  state.quiz.pool = buildQuizPool();
  state.quiz.index = 0; 
  state.quiz.right = 0; 
  state.quiz.finished = false;
  quizRestart.hidden = true;

  if (state.quiz.pool.length === 0){
    quizMeta.textContent = '–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –∫–≤–∏–∑–∞ ‚Äî –æ—Ç–º–µ—Ç—å—Ç–µ ¬´–ü–æ–≤—Ç–æ—Ä–∏—Ç—å¬ª –∏–ª–∏ —Å –Ω–∏–∑–∫–∏–º Box.';
    quizPrompt.textContent = '–ü—É–ª –ø—É—Å—Ç.';
    quizOpts.innerHTML = '';
    return;
  }

  nextQuizQ();
} // ‚Üê –∑–¥–µ—Å—å –∑–∞–∫—Ä—ã–≤–∞–µ–º startQuiz

// ‚Üê –∏ –¢–ï–ü–ï–†–¨ ‚Äî –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π (–≤–Ω–µ startQuiz)
function repaintQuizCurrent(){
  const q = state.quiz;
  if (!q || q.finished) return;

  if (!q.pool || q.pool.length === 0){
    startQuiz();
    return;
  }

  const card = q.pool[q.index];
  const { prompt, options, correctIndex } = choiceSet(
    card, state.cards, state.shuffleSeed + q.index
  );

  quizPrompt.textContent = prompt;
  quizOpts.innerHTML = '';
  options.forEach((opt, i) => {
    const b = document.createElement('button');
    b.textContent = opt;
    b.addEventListener('click', ()=>{
      const children = Array.from(quizOpts.children);
      children.forEach((x, idx) => x.classList.toggle('correct', idx === correctIndex));

      if (i === correctIndex) {
        q.right++;
        card.box = clamp(card.box+1, 1, 5);
        card.repeat = false;
        card.last = now();
      } else {
        card.repeat = true;
        card.box = 1;
        card.learned = false;
        card.hard = true;
        children[i].classList.add('wrong');
      }

      saveState();
      refreshProgressUI();
      renderList();

      children.forEach(x => x.disabled = true);
      setTimeout(()=>{ q.index++; nextQuizQ(); }, 550);
    }, { once:true });
    quizOpts.appendChild(b);
  });

  quizRestart.hidden = true;
  quizMeta.textContent = `–≤–æ–ø—Ä–æ—Å ${q.index+1} –∏–∑ ${q.pool.length}, –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö ${q.right}`;
}

  function choiceSet(correct, allCards, seed){
    const pool=allCards.filter(c=>c.id!==correct.id); const opts=[]; let s=seed;
    while(opts.length<3 && pool.length){ s+=.73; const i=Math.floor(prng(s)*pool.length); const [pick]=pool.splice(i,1); opts.push(pick); }
    const prompt= state.direction==='EN2ES'? correct.front : correct.back;
    const correctAns= state.direction==='EN2ES'? correct.back : correct.front;
    const answers=[correctAns, ...opts.map(c=> state.direction==='EN2ES'? c.back : c.front )];
    const arr=answers.map((v,i)=>({v,i})); for(let i=arr.length-1;i>0;i--){ s+=.41; const j=Math.floor(prng(s)*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    return { prompt, options: arr.map(x=>x.v), correctIndex: arr.findIndex(x=>x.i===0) };
  }
  function nextQuizQ(){
    const q=state.quiz, total=q.pool.length;
    if(q.index>=total){ q.finished=true; quizMeta.textContent=`–ì–æ—Ç–æ–≤–æ! –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö ${q.right} –∏–∑ ${total}`; quizPrompt.textContent='–ö–≤–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω'; quizOpts.innerHTML=''; quizRestart.hidden=false; return; }
    const card=q.pool[q.index]; const {prompt,options,correctIndex}=choiceSet(card,state.cards,state.shuffleSeed+q.index);
    quizPrompt.textContent=prompt; quizOpts.innerHTML='';
    options.forEach((opt,i)=>{ const b=document.createElement('button'); b.textContent=opt;
      b.addEventListener('click', ()=>{
        const children=Array.from(quizOpts.children); children.forEach((x,idx)=>x.classList.toggle('correct', idx===correctIndex));
        if(i===correctIndex){ q.right++; card.box=clamp(card.box+1,1,5); card.repeat=false; card.last=now(); }
        else{ card.repeat=true; card.box=1; card.learned=false; card.hard=true; children[i].classList.add('wrong'); }
        saveState(); refreshProgressUI(); renderList(); children.forEach(x=>x.disabled=true); setTimeout(()=>{ q.index++; nextQuizQ(); }, 550);
      }, {once:true});
      quizOpts.appendChild(b);
    });
    quizRestart.hidden=true; quizMeta.textContent=`–≤–æ–ø—Ä–æ—Å ${q.index+1} –∏–∑ ${total}, –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö ${q.right}`;
  }
  quizRestart.addEventListener('click', startQuiz);

  /** ---------- Autotranslate (online + offline >1000) ---------- */
  const LT_ENDPOINTS = [
    'https://libretranslate.de/translate',
    'https://translate.terraprint.co/translate',
    'https://libretranslate.com/translate'
  ];

  // –ë–∞–∑–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞ (EN‚ÜíES) + –≥–µ–Ω–¥–µ—Ä (m/f) –¥–ª—è –∞—Ä—Ç–∏–∫–ª—è
  const NOUNS = {
    "airport":{es:"aeropuerto",g:"m"},"station":{es:"estaci√≥n",g:"f"},"bus":{es:"autob√∫s",g:"m"},"train":{es:"tren",g:"m"},
    "taxi":{es:"taxi",g:"m"},"subway":{es:"metro",g:"m"},"ticket":{es:"billete",g:"m"},"toilet":{es:"ba√±o",g:"m"},
    "bathroom":{es:"ba√±o",g:"m"},"pharmacy":{es:"farmacia",g:"f"},"hospital":{es:"hospital",g:"m"},"doctor":{es:"m√©dico",g:"m"},
    "police":{es:"polic√≠a",g:"f"},"hotel":{es:"hotel",g:"m"},"room":{es:"habitaci√≥n",g:"f"},"key":{es:"llave",g:"f"},
    "reception":{es:"recepci√≥n",g:"f"},"restaurant":{es:"restaurante",g:"m"},"menu":{es:"men√∫",g:"m"},"breakfast":{es:"desayuno",g:"m"},
    "lunch":{es:"almuerzo",g:"m"},"dinner":{es:"cena",g:"f"},"water":{es:"agua",g:"f"},"coffee":{es:"caf√©",g:"m"},
    "tea":{es:"t√©",g:"m"},"beer":{es:"cerveza",g:"f"},"wine":{es:"vino",g:"m"},"bread":{es:"pan",g:"m"},
    "bottle":{es:"botella",g:"f"},"glass":{es:"vaso",g:"m"},"plate":{es:"plato",g:"m"},"fork":{es:"tenedor",g:"m"},
    "knife":{es:"cuchillo",g:"m"},"spoon":{es:"cuchara",g:"f"},"napkin":{es:"servilleta",g:"f"},"salt":{es:"sal",g:"f"},
    "sugar":{es:"az√∫car",g:"m"},"pepper":{es:"pimienta",g:"f"},"oil":{es:"aceite",g:"m"},"bill":{es:"cuenta",g:"f"},
    "receipt":{es:"recibo",g:"m"},"discount":{es:"descuento",g:"m"},"market":{es:"mercado",g:"m"},"supermarket":{es:"supermercado",g:"m"},
    "store":{es:"tienda",g:"f"},"shop":{es:"tienda",g:"f"},"cash":{es:"efectivo",g:"m"},"card":{es:"tarjeta",g:"f"},
    "bank":{es:"banco",g:"m"},"atm":{es:"cajero",g:"m"},"map":{es:"mapa",g:"m"},"street":{es:"calle",g:"f"},
    "center":{es:"centro",g:"m"},"beach":{es:"playa",g:"f"},"park":{es:"parque",g:"m"},"museum":{es:"museo",g:"m"},
    "ticket office":{es:"taquilla",g:"f"},"platform":{es:"and√©n",g:"m"},"gate":{es:"puerta",g:"f"},"passport":{es:"pasaporte",g:"m"},
    "phone":{es:"tel√©fono",g:"m"},"charger":{es:"cargador",g:"m"},"adapter":{es:"adaptador",g:"m"},"wifi":{es:"wifi",g:"m"},
    "password":{es:"contrase√±a",g:"f"},"reservation":{es:"reserva",g:"f"},"table":{es:"mesa",g:"f"},"chair":{es:"silla",g:"f"},
    "left":{es:"izquierda",g:"f"},"right":{es:"derecha",g:"f"},"airport bus":{es:"autob√∫s del aeropuerto",g:"m"},
    "entrance":{es:"entrada",g:"f"},"exit":{es:"salida",g:"f"},"pharmacy on duty":{es:"farmacia de guardia",g:"f"}
  };

  const FIXED_EN2ES = {
    "hello":"hola","hi":"hola","good morning":"buenos d√≠as","good afternoon":"buenas tardes","good evening":"buenas noches",
    "good night":"buenas noches","please":"por favor","thank you":"gracias","thanks":"gracias","you are welcome":"de nada",
    "sorry":"lo siento","excuse me":"disculpe","yes":"s√≠","no":"no","help":"ayuda","i don‚Äôt understand":"no entiendo",
    "i don't understand":"no entiendo","do you speak english?":"¬øhabla ingl√©s?","i speak a little spanish":"hablo un poco de espa√±ol",
    "how much is this?":"¬øcu√°nto cuesta esto?","where is the bathroom?":"¬ød√≥nde est√° el ba√±o?","the bill, please":"la cuenta, por favor",
    "one ticket, please":"un billete, por favor","water, please":"agua, por favor","i would like":"me gustar√≠a","i need help":"necesito ayuda"
  };

  // –ü—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–∞ (0-100) –¥–ª—è —Ñ—Ä–∞–∑ "‚Ä¶ euros"
  const NUM = ["zero","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen","twenty"];
  function enNumberToEs(s){
    const m = s.match(/^(\d{1,3})(\s+)?(euros|euro)?$/);
    if(!m) return null;
    const n = +m[1]; const tail = m[3] ? ' euros' : '';
    const specials = {0:'cero',1:'uno',2:'dos',3:'tres',4:'cuatro',5:'cinco',6:'seis',7:'siete',8:'ocho',9:'nueve',10:'diez',11:'once',12:'doce',13:'trece',14:'catorce',15:'quince',20:'veinte',30:'treinta',40:'cuarenta',50:'cincuenta',60:'sesenta',70:'setenta',80:'ochenta',90:'noventa',100:'cien'};
    if(specials[n]) return specials[n] + (tail? ' euros':'');
    if(n<20) return specials[n]+(tail?' euros':'');
    if(n<100){ const tens=Math.floor(n/10)*10; const ones=n%10; return specials[tens] + (ones? ' y '+specials[ones]:'') + (tail?' euros':''); }
    if(n===100) return 'cien' + (tail?' euros':'');
    return null;
  }

  function art(word, g){ // –∞—Ä—Ç–∏–∫–ª—å —Å —É—á—ë—Ç–æ–º –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —É–¥–∞—Ä–Ω–æ–≥–æ a- (agua ‚Üí el agua)
    if(g==='m') return 'el ' + word;
    // femeninos con a- t√≥nica usan "el" –≤ –µ–¥. —á–∏—Å–ª–µ (agua, √°guila‚Ä¶)
    if(g==='f' && /^[a√°]gua|^[a√°]guila|^[a√°]rpa|^[a√°]rea/.test(word)) return 'el ' + word;
    return 'la ' + word;
  }

  function findNoun(en){
    const k = en.toLowerCase().trim();
    if(NOUNS[k]) return NOUNS[k];
    // –ø–æ–ø—ã—Ç–∫–∞ –±–µ–∑ –∞—Ä—Ç–∏–∫–ª—è
    const noArticle = k.replace(/^(the|a|an)\s+/,'').trim();
    return NOUNS[noArticle] || null;
  }

  function templateEN2ES(s){
    let t = s.trim().toLowerCase().replace(/\s+/g,' ');
    if(FIXED_EN2ES[t]) return FIXED_EN2ES[t];

    // –ß–∏—Å–ª–∞ / —Ü–µ–Ω—ã
    const num = enNumberToEs(t);
    if(num) return num;

    // where is the [NOUN]
    let m = t.match(/^where\s+is\s+(the\s+|a\s+|an\s+)?(.+)\??$/);
    if(m){
      const n = findNoun(m[2]); if(n) return `¬ød√≥nde est√° ${art(n.es,n.g)}?`;
    }

    // do you have [NOUN]
    m = t.match(/^do\s+you\s+have\s+(the\s+|a\s+|an\s+)?(.+)\??$/);
    if(m){
      const n = findNoun(m[2]); if(n) return `¬øtiene ${art(n.es,n.g)}?`;
    }

    // i need / i want / i would like [NOUN]
    m = t.match(/^i\s+(need|want|would like)\s+(the\s+|a\s+|an\s+)?(.+)\.?$/);
    if(m){
      const verb = m[1]==='need' ? 'necesito' : (m[1]==='want' ? 'quiero' : 'me gustar√≠a');
      const n = findNoun(m[3]);
      if(n) return `${verb} ${art(n.es,n.g)}`;
    }

    // one/two ... [NOUN] please
    m = t.match(/^(one|two|three|four|five)\s+(.+)\s+please\.?$/);
    if(m){
      const numMap = {one:'un',two:'dos',three:'tres',four:'cuatro',five:'cinco'};
      const n = findNoun(m[2]); if(n) return `${numMap[m[1]]} ${n.es}, por favor`;
    }

    // how much is (the) [NOUN]
    m = t.match(/^how\s+much\s+is\s+(the\s+|a\s+|an\s+)?(.+)\??$/);
    if(m){
      const n = findNoun(m[2]); if(n) return `¬øcu√°nto cuesta ${art(n.es,n.g)}?`;
    }

    // turn left/right
    m = t.match(/^turn\s+(left|right)\.?$/);
    if(m){
      const dir = m[1]==='left' ? 'izquierda' : 'derecha';
      return `gire a la ${dir}`;
    }

    // simple greetings variants
    m = t.match(/^good\s+(morning|afternoon|evening|night)\.?$/);
    if(m){
      return {morning:'buenos d√≠as',afternoon:'buenas tardes',evening:'buenas noches',night:'buenas noches'}[m[1]];
    }

    return null; // –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–ª–∏
  }

  function templateES2EN(s){
    const t = s.trim().toLowerCase();
    // –æ–±—Ä–∞—Ç–Ω—ã–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
    for(const [k,v] of Object.entries(FIXED_EN2ES)){ if(v===t) return k; }
    // –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
    if(/^¬ød√≥nde est√° /.test(t)) return 'where is it?';
    if(/^¬øtiene /.test(t)) return 'do you have it?';
    if(/^gire a la /.test(t)) return 'turn (left/right)';
    return null;
  }

  const SMALL_DICT_EN2ES = {
    "where is the bathroom?":"¬ød√≥nde est√° el ba√±o?","the bill, please":"la cuenta, por favor","water":"agua","coffee":"caf√©",
    "tea":"t√©","bread":"pan","help":"ayuda","i need help":"necesito ayuda","i would like a coffee":"me gustar√≠a un caf√©",
    "one ticket please":"un billete, por favor"
  };
  const SMALL_DICT_ES2EN = Object.fromEntries(Object.entries(SMALL_DICT_EN2ES).map(([k,v])=>[v,k]));

  async function translateOnline(q, dir, signal){
    const payload = { q, source: dir==='EN2ES'?'en':'es', target: dir==='EN2ES'?'es':'en', format:'text' };
    for(const url of LT_ENDPOINTS){
      try{
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), signal });
        if(!res.ok) continue;
        const data = await res.json();
        const txt = data?.translatedText || '';
        if(txt) return txt;
      }catch(e){ /* try next */ }
    }
    throw new Error('online_fail');
  }

  function offlineTranslate(text, dir){
    const t = (text||'').trim().toLowerCase();
    if(!t) return '';
    if(dir==='EN2ES'){
      if(SMALL_DICT_EN2ES[t]) return SMALL_DICT_EN2ES[t];
      const byTpl = templateEN2ES(t);
      if(byTpl) return byTpl;
      // fallback –∑–∞–º–µ–Ω—ã –∞—Ä—Ç–∏–∫–ª–µ–π
      const rm = t.replace(/\b(the|a|an)\b/g,'').trim();
      const n = findNoun(rm); if(n) return n.es;
    } else {
      if(SMALL_DICT_ES2EN[t]) return SMALL_DICT_ES2EN[t];
      const byTpl = templateES2EN(t); if(byTpl) return byTpl;
    }
    return t; // –∫–∞–∫ –µ—Å—Ç—å
  }

  function setTrStatus(msg){ trStatus.innerHTML = msg? `<span>${msg}</span>` : '<span class="spinner"></span>'; }
  let trAbort = null;
  function withTimeout(ms){
    const c = new AbortController();
    const t = setTimeout(()=>c.abort(), ms);
    c.cleanup = ()=> clearTimeout(t);
    return c;
  }

  async function doTranslateActive(){
    const front = addFront.value.trim();
    const back  = addBack.value.trim();
    let fromEl, toEl, dir;

    if(front && !back){ dir='EN2ES'; fromEl=addFront; toEl=addBack; }
    else if(back && !front){ dir='ES2EN'; fromEl=addBack; toEl=addFront; }
    else return;

    setTrStatus('–ü–µ—Ä–µ–≤–æ–¥‚Ä¶');
    btnTranslate.disabled = true;

    if(trAbort){ try{ trAbort.abort(); }catch{} }
    trAbort = withTimeout(5000);

    try{
      const online = await translateOnline(fromEl.value, dir, trAbort.signal);
      toEl.value = online;
      setTrStatus('–ì–æ—Ç–æ–≤–æ ‚úì');
    }catch(e){
      // –æ—Ñ–ª–∞–π–Ω —à–∞–±–ª–æ–Ω—ã (>1000 –∫–æ–º–±–∏–Ω–∞—Ü–∏–π)
      toEl.value = offlineTranslate(fromEl.value, dir);
      setTrStatus('–û—Ñ—Ñ–ª–∞–π–Ω –ø–µ—Ä–µ–≤–æ–¥');
    }finally{
      btnTranslate.disabled = false;
      if(trAbort?.cleanup) trAbort.cleanup();
      trAbort = null;
    }
  }

  // debounce –¥–ª—è –∞–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥–∞
  let trTimer = null;
  function scheduleAutoTranslate(){
    if(!autoTranslate.checked) return;
    if(trTimer) clearTimeout(trTimer);
    trTimer = setTimeout(()=>{ doTranslateActive(); }, 600);
  }

  /** Keyboard & Clicks */
  function hasInputFocus(){ const ae=document.activeElement; return ae && (['INPUT','TEXTAREA'].includes(ae.tagName) || ae.isContentEditable); }
  window.addEventListener('keydown', (e)=>{ if(hasInputFocus()) return; if(state.tab!=='flash') return;
    if(e.code==='Space'){ e.preventDefault(); flipCard(); }
    else if(e.key==='ArrowRight'){ e.preventDefault(); applyLearned(); }
    else if(e.key==='ArrowLeft'){ e.preventDefault(); applyRepeat(); }
    else if((e.key||'').toLowerCase()==='n'){ e.preventDefault(); nextCard(); }
  });

  $('#zoneFlip').addEventListener('click', ()=>flipCard());
  $('#zoneNext').addEventListener('click', ()=>nextCard());
  $('#zoneBack').addEventListener('click', ()=>prevCard());
  btnLearned.addEventListener('click', applyLearned);
  btnRepeat.addEventListener('click', applyRepeat);
  tabFlash.addEventListener('click', ()=>switchTab('flash'));
  tabQuiz .addEventListener('click', ()=>switchTab('quiz'));
  btnSettings.addEventListener('click', ()=>{
  buildPalettes();                                  // –ø–∞–ª–∏—Ç—Ä—ã
  if (settingsListWrap && elList && elList.parentElement !== settingsListWrap) {
    settingsListWrap.appendChild(elList);           // –ø–µ—Ä–µ–Ω–æ—Å–∏–º #list –≤ –º–æ–¥–∞–ª–∫—É
  }
  renderList();

  // ‚ùó –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –∑–∞–∫—Ä—ã—Ç—ã–º —Å–ø–∏—Å–∫–æ–º
  state.showList = false;
  applyListVisibility();

  dlgSettings.showModal();
});

  if (btnAdd) {
  btnAdd.addEventListener('click', () => {
    document.activeElement?.blur?.();        // –≥–∞—Å–∏–º –≤–æ–∑–º–æ–∂–Ω—ã–π —Ñ–æ–∫—É—Å
    dlgAdd.showModal();                       // –æ—Ç–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥
    dlgAdd.focus({ preventScroll: true });    // —Ñ–æ–∫—É—Å –Ω–∞ –¥–∏–∞–ª–æ–≥
  });
}

  addFront.addEventListener('input', scheduleAutoTranslate);
  addBack .addEventListener('input', scheduleAutoTranslate);
  btnTranslate.addEventListener('click', doTranslateActive);

    // –î–∏–∞–ª–æ–≥ "–ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞" ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
btnClearAdd.addEventListener('click', () => {
  addFront.value = '';
  addBack.value  = '';
  addFront.focus();
});

btnAddClose.addEventListener('click', () => {
  dlgAdd.close();
  btnAdd.focus(); // –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—Ç —Ñ–æ–∫—É—Å–∞ –Ω–∞ "Ôºã"
});

addForm.addEventListener('submit', (ev) => {
  ev.preventDefault();
  const f = addFront.value.trim();
  const b = addBack.value.trim();
  if (!f || !b) return;

  addCard(f, b);
  addFront.value = '';
  addBack.value  = '';
  refreshProgressUI();
  renderList();
  renderFlash();
  dlgAdd.close();
});

    /** Init */
  function init(){
    const loaded = loadState();
    if (loaded) Object.assign(state, loaded);
if (!Array.isArray(state.history)) state.history = [];

    // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è —Ç–µ–º–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (–∫–æ–≥–¥–∞ –≤ localStorage –µ—â—ë –ø—É—Å—Ç–æ)
    if (!state.theme || (!state.theme.bg0 && !state.theme.card1)) {
      state.theme = {
        ...BG_PRESETS[0],   // { bg0, bg1 }
        ...CARD_PRESETS[0]  // { card1, card2 }
      };
      applyTheme(state.theme);
      saveState();
    } else {
      applyTheme(state.theme);
    }

    ensureDemo();
    elBtnDir.textContent = directionLabel();
    renderFlash();
    renderList();
    refreshProgressUI();
    applyListVisibility();
    switchTab(state.tab || 'flash');
    flipCard(false);

    miniTests();
  }
  init();

  /** Mini tests */
  function miniTests(){
  console.log('%cMini tests','background:#352b66;color:#fff;padding:2px 6px;border-radius:6px');
  const seedBefore=state.shuffleSeed;
  const weights=state.cards.map(c=>1/Math.max(1,c.box));
  const pick1=weightedPick(weights,null,seedBefore);
  const seedAfter=state.shuffleSeed;
  console.log('Seed immutable:', seedBefore===seedAfter, {pick1,seedBefore,seedAfter});
  const tmp=[{box:5,learned:false},{box:1,learned:true},{box:3}];
  const learnedCount=tmp.filter(c=>c.learned||c.box>=4).length;
  console.log('Progress test (2):', learnedCount);
}
})();
</script>
</body>
</html>
